/**
 * SOLUZIONE ESERCIZIO C.2 - Sistema di Gestione Magazzino
 * 
 * OBIETTIVO:
 * Sistema completo per gestire un magazzino di prodotti che dimostra
 * l'uso avanzato di input/output, formattazione e gestione dati.
 * 
 * FUNZIONALIT√Ä IMPLEMENTATE:
 * 1. Inserimento prodotti con validazione input completa
 * 2. Calcolo automatico di prezzi e sconti con precision decimal
 * 3. Gestione inventario con quantit√† e soglie di allerta
 * 4. Report formattati con tabelle e statistiche dettagliate
 * 5. Input/Output da tastiera con menu interattivo
 * 6. Ricerca avanzata con multipli criteri
 * 7. Sistema di carico/scarico merci
 * 
 * CONCETTI APPLICATI:
 * - Input/Output formattato con printf e DecimalFormat
 * - Validazione robusta e gestione errori input
 * - Calcoli con precision decimal per evitare errori floating-point
 * - Formattazione professionale di valute e percentuali
 * - Strutture dati semplici ottimizzate (array paralleli)
 * - Logica di business con controlli e validazioni
 * - Pattern di menu navigation con switch-case
 * - Gestione stato applicazione
 * 
 * @author Soluzione Ufficiale
 * @version 1.0
 */

import java.util.Scanner;
import java.text.DecimalFormat;
import java.text.NumberFormat;
import java.util.Locale;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.math.BigDecimal;
import java.math.RoundingMode;

public class Esercizio02_GestioneMagazzino_Soluzione {
    
    // Costanti per la configurazione del sistema
    private static final int MAX_PRODOTTI = 50;
    private static final double IVA_STANDARD = 0.22; // 22%
    private static final double SOGLIA_SCORTE_BASSE = 10;
    
    // Array paralleli per memorizzare i dati dei prodotti
    private static String[] codici = new String[MAX_PRODOTTI];
    private static String[] nomi = new String[MAX_PRODOTTI];
    private static String[] categorie = new String[MAX_PRODOTTI];
    private static double[] prezziUnitari = new double[MAX_PRODOTTI];
    private static int[] quantita = new int[MAX_PRODOTTI];
    private static double[] sconti = new double[MAX_PRODOTTI]; // Percentuale sconto
    private static boolean[] attivi = new boolean[MAX_PRODOTTI];
    
    private static int numProdotti = 0;
    
    // Formattatori per output professionale
    private static final DecimalFormat formattoPrezzo = new DecimalFormat("#,##0.00 ‚Ç¨");
    private static final DecimalFormat formattoPercentuale = new DecimalFormat("#0.0%");
    private static final NumberFormat formattoValuta = NumberFormat.getCurrencyInstance(Locale.ITALY);
    private static final DateTimeFormatter formattoData = DateTimeFormatter.ofPattern("dd/MM/yyyy HH:mm:ss");
    
    private static Scanner scanner = new Scanner(System.in);
    
    /**
     * Menu principale del sistema
     */
    public static void main(String[] args) {
        System.out.println("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
        System.out.println("‚ïë     SISTEMA GESTIONE MAGAZZINO         ‚ïë");
        System.out.println("‚ïë   Esercizio C.2 - I/O e Formattazione  ‚ïë");
        System.out.println("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
        System.out.println();
        
        // Carica dati di esempio per il testing
        caricaDatiEsempio();
        
        boolean continua = true;
        while (continua) {
            mostraMenu();
            int scelta = leggiIntero("üëâ Inserisci la tua scelta: ");
            
            switch (scelta) {
                case 1:
                    inserisciProdotto();
                    break;
                case 2:
                    visualizzaProdotti();
                    break;
                case 3:
                    modificaProdotto();
                    break;
                case 4:
                    calcolaValore();
                    break;
                case 5:
                    gestioneInventario();
                    break;
                case 6:
                    generaReport();
                    break;
                case 7:
                    ricercaProdotti();
                    break;
                case 0:
                    continua = false;
                    System.out.println("\nüëã Grazie per aver utilizzato il sistema!");
                    System.out.println("üíæ Tutti i dati sono stati salvati in memoria.");
                    break;
                default:
                    System.out.println("‚ùå Scelta non valida! Riprova.");
            }
            
            if (continua) {
                System.out.println("\n‚è∏Ô∏è Premi INVIO per continuare...");
                scanner.nextLine();
            }
        }
        
        scanner.close();
    }
    
    /**
     * Mostra il menu principale con interfaccia grafica ASCII
     */
    private static void mostraMenu() {
        System.out.println("\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
        System.out.println("‚ïë            MENU PRINCIPALE           ‚ïë");
        System.out.println("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£");
        System.out.println("‚ïë 1. üì¶ Inserisci nuovo prodotto      ‚ïë");
        System.out.println("‚ïë 2. üìã Visualizza prodotti           ‚ïë");
        System.out.println("‚ïë 3. ‚úèÔ∏è  Modifica prodotto             ‚ïë");
        System.out.println("‚ïë 4. üí∞ Calcola valore magazzino      ‚ïë");
        System.out.println("‚ïë 5. üìä Gestione inventario           ‚ïë");
        System.out.println("‚ïë 6. üìÑ Genera report completo        ‚ïë");
        System.out.println("‚ïë 7. üîç Ricerca prodotti              ‚ïë");
        System.out.println("‚ïë 0. üö™ Esci dal sistema              ‚ïë");
        System.out.println("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
    }
    
    /**
     * SOLUZIONE 1: Inserimento nuovo prodotto con validazione completa
     */
    private static void inserisciProdotto() {
        System.out.println("\n=== üì¶ INSERIMENTO NUOVO PRODOTTO ===");
        
        if (numProdotti >= MAX_PRODOTTI) {
            System.out.println("‚ùå Magazzino pieno! Impossibile aggiungere altri prodotti.");
            System.out.printf("üìä Capacit√† massima: %d prodotti%n", MAX_PRODOTTI);
            return;
        }
        
        // 1. Validazione codice prodotto (formato: PRD-XXXX)
        String codice;
        do {
            System.out.print("üìù Codice prodotto (formato PRD-XXXX): ");
            codice = scanner.nextLine().trim().toUpperCase();
            
            if (!validaCodice(codice)) {
                System.out.println("‚ùå Formato codice non valido! Usa: PRD-XXXX (dove X sono cifre)");
                continue;
            }
            
            if (esisteCodice(codice)) {
                System.out.println("‚ùå Codice gi√† esistente! Scegli un codice diverso.");
                continue;
            }
            
            break;
        } while (true);
        
        // 2. Validazione nome prodotto
        String nome;
        do {
            System.out.print("üìù Nome prodotto: ");
            nome = scanner.nextLine().trim();
            
            if (nome.isEmpty()) {
                System.out.println("‚ùå Il nome non pu√≤ essere vuoto!");
                continue;
            }
            
            if (nome.length() < 3) {
                System.out.println("‚ùå Il nome deve essere di almeno 3 caratteri!");
                continue;
            }
            
            break;
        } while (true);
        
        // 3. Scelta categoria
        String categoria = scegliCategoria();
        
        // 4. Validazione prezzo unitario
        double prezzo;
        do {
            prezzo = leggiDouble("üí∞ Prezzo unitario (‚Ç¨): ");
            
            if (prezzo <= 0) {
                System.out.println("‚ùå Il prezzo deve essere positivo!");
                continue;
            }
            
            if (prezzo > 100000) {
                System.out.println("‚ùå Prezzo troppo alto! Massimo ‚Ç¨100,000");
                continue;
            }
            
            break;
        } while (true);
        
        // 5. Validazione quantit√† iniziale
        int qta;
        do {
            qta = leggiIntero("üì¶ Quantit√† iniziale: ");
            
            if (qta < 0) {
                System.out.println("‚ùå La quantit√† non pu√≤ essere negativa!");
                continue;
            }
            
            if (qta > 10000) {
                System.out.println("‚ùå Quantit√† troppo alta! Massimo 10,000 unit√†");
                continue;
            }
            
            break;
        } while (true);
        
        // 6. Validazione sconto (opzionale)
        double sconto = 0;
        System.out.print("üè∑Ô∏è Sconto % (0-100, invio per saltare): ");
        String scontoStr = scanner.nextLine().trim();
        if (!scontoStr.isEmpty()) {
            try {
                sconto = Double.parseDouble(scontoStr);
                if (sconto < 0 || sconto > 100) {
                    System.out.println("‚ö†Ô∏è Sconto non valido (range 0-100%), impostato a 0%");
                    sconto = 0;
                }
            } catch (NumberFormatException e) {
                System.out.println("‚ö†Ô∏è Sconto non valido, impostato a 0%");
                sconto = 0;
            }
        }
        
        // Salvataggio del prodotto negli array
        codici[numProdotti] = codice;
        nomi[numProdotti] = nome;
        categorie[numProdotti] = categoria;
        prezziUnitari[numProdotti] = prezzo;
        quantita[numProdotti] = qta;
        sconti[numProdotti] = sconto;
        attivi[numProdotti] = true;
        
        numProdotti++;
        
        System.out.println("\n‚úÖ Prodotto inserito con successo!");
        System.out.println("üì¶ DETTAGLI PRODOTTO INSERITO:");
        stampaProdotto(numProdotti - 1);
        
        // Alert se quantit√† bassa
        if (qta <= SOGLIA_SCORTE_BASSE) {
            System.out.println("‚ö†Ô∏è ATTENZIONE: Scorte basse per questo prodotto!");
        }
    }
    
    /**
     * SOLUZIONE 2: Visualizzazione prodotti in formato tabellare professionale
     */
    private static void visualizzaProdotti() {
        System.out.println("\n=== üìã LISTA PRODOTTI ===");
        
        if (numProdotti == 0) {
            System.out.println("üì≠ Nessun prodotto presente nel magazzino.");
            System.out.println("üí° Usa l'opzione 1 per inserire il primo prodotto.");
            return;
        }
        
        int prodottiAttivi = contaProdottiAttivi();
        if (prodottiAttivi == 0) {
            System.out.println("üì≠ Tutti i prodotti sono stati disattivati.");
            return;
        }
        
        // Intestazione tabella con formattazione professionale
        System.out.println("\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê");
        System.out.println("‚îÇ  CODICE  ‚îÇ        NOME        ‚îÇ  CATEGORIA  ‚îÇ   PREZZO  ‚îÇ   QT√Ä   ‚îÇ SCONTO  ‚îÇ    VALORE   ‚îÇ");
        System.out.println("‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§");
        
        // Visualizzazione di tutti i prodotti attivi
        for (int i = 0; i < numProdotti; i++) {
            if (attivi[i]) {
                double valoreTotale = calcolaValoreProdotto(i);
                String statusQuantita = quantita[i] <= SOGLIA_SCORTE_BASSE ? "‚ö†Ô∏è" : "‚úÖ";
                
                System.out.printf("‚îÇ %-8s ‚îÇ %-18s ‚îÇ %-11s ‚îÇ %9s ‚îÇ %4d %s ‚îÇ %6s  ‚îÇ %11s ‚îÇ%n",
                    codici[i],
                    limitaStringa(nomi[i], 18),
                    limitaStringa(categorie[i], 11),
                    formattoPrezzo.format(prezziUnitari[i]),
                    quantita[i],
                    statusQuantita,
                    formattoPercentuale.format(sconti[i] / 100),
                    formattoPrezzo.format(valoreTotale)
                );
            }
        }
        
        System.out.println("‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò");
        
        // Statistiche riassuntive
        double valoreTotale = calcolaValoreTotale();
        int prodottiBasse = contaScorteBasse();
        
        System.out.println("\nüìä STATISTICHE MAGAZZINO:");
        System.out.printf("üì¶ Prodotti attivi: %d su %d totali%n", prodottiAttivi, numProdotti);
        System.out.printf("üí∞ Valore totale magazzino: %s%n", formattoPrezzo.format(valoreTotale));
        System.out.printf("‚ö†Ô∏è Prodotti con scorte basse: %d%n", prodottiBasse);
        
        if (prodottiBasse > 0) {
            System.out.println("üîî SUGGERIMENTO: Controlla l'inventario (opzione 5) per rifornire i prodotti.");
        }
    }
    
    /**
     * SOLUZIONE 3: Modifica prodotto esistente con menu completo
     */
    private static void modificaProdotto() {
        System.out.println("\n=== ‚úèÔ∏è MODIFICA PRODOTTO ===");
        
        if (numProdotti == 0) {
            System.out.println("üì≠ Nessun prodotto da modificare.");
            return;
        }
        
        // Ricerca prodotto per codice
        System.out.print("üîç Inserisci codice prodotto da modificare: ");
        String codice = scanner.nextLine().trim().toUpperCase();
        
        int indice = trovaProdotto(codice);
        if (indice == -1) {
            System.out.println("‚ùå Prodotto non trovato!");
            System.out.println("üí° Suggerimento: Usa l'opzione 2 per vedere tutti i codici disponibili.");
            return;
        }
        
        // Mostra prodotto corrente
        System.out.println("\nüì¶ PRODOTTO CORRENTE:");
        stampaProdotto(indice);
        
        // Menu per scegliere cosa modificare
        System.out.println("\nüõ†Ô∏è COSA VUOI MODIFICARE?");
        System.out.println("1. üìù Nome prodotto");
        System.out.println("2. üìÇ Categoria");
        System.out.println("3. üí∞ Prezzo unitario");
        System.out.println("4. üì¶ Quantit√†");
        System.out.println("5. üè∑Ô∏è Sconto");
        System.out.println("6. ‚ùå Disattiva prodotto");
        System.out.println("7. ‚úÖ Riattiva prodotto");
        System.out.println("0. üö´ Annulla modifica");
        
        int scelta = leggiIntero("üëâ Scelta: ");
        
        switch (scelta) {
            case 1: // Modifica nome
                System.out.printf("üìù Nome attuale: %s%n", nomi[indice]);
                String nuovoNome;
                do {
                    System.out.print("üìù Nuovo nome: ");
                    nuovoNome = scanner.nextLine().trim();
                    if (nuovoNome.isEmpty() || nuovoNome.length() < 3) {
                        System.out.println("‚ùå Nome non valido! Minimo 3 caratteri.");
                        continue;
                    }
                    break;
                } while (true);
                nomi[indice] = nuovoNome;
                break;
                
            case 2: // Modifica categoria
                System.out.printf("üìÇ Categoria attuale: %s%n", categorie[indice]);
                categorie[indice] = scegliCategoria();
                break;
                
            case 3: // Modifica prezzo
                System.out.printf("üí∞ Prezzo attuale: %s%n", formattoPrezzo.format(prezziUnitari[indice]));
                double nuovoPrezzo;
                do {
                    nuovoPrezzo = leggiDouble("üí∞ Nuovo prezzo (‚Ç¨): ");
                    if (nuovoPrezzo <= 0) {
                        System.out.println("‚ùå Il prezzo deve essere positivo!");
                        continue;
                    }
                    break;
                } while (true);
                prezziUnitari[indice] = nuovoPrezzo;
                break;
                
            case 4: // Modifica quantit√†
                System.out.printf("üì¶ Quantit√† attuale: %d%n", quantita[indice]);
                int nuovaQuantita;
                do {
                    nuovaQuantita = leggiIntero("üì¶ Nuova quantit√†: ");
                    if (nuovaQuantita < 0) {
                        System.out.println("‚ùå La quantit√† non pu√≤ essere negativa!");
                        continue;
                    }
                    break;
                } while (true);
                quantita[indice] = nuovaQuantita;
                if (nuovaQuantita <= SOGLIA_SCORTE_BASSE) {
                    System.out.println("‚ö†Ô∏è ATTENZIONE: Scorte basse!");
                }
                break;
                
            case 5: // Modifica sconto
                System.out.printf("üè∑Ô∏è Sconto attuale: %s%n", formattoPercentuale.format(sconti[indice] / 100));
                double nuovoSconto = leggiDouble("üè∑Ô∏è Nuovo sconto % (0-100): ");
                if (nuovoSconto < 0 || nuovoSconto > 100) {
                    System.out.println("‚ö†Ô∏è Sconto non valido, mantenuto valore precedente.");
                } else {
                    sconti[indice] = nuovoSconto;
                }
                break;
                
            case 6: // Disattiva prodotto
                if (!attivi[indice]) {
                    System.out.println("‚ö†Ô∏è Il prodotto √® gi√† disattivato.");
                } else {
                    System.out.print("‚ö†Ô∏è Confermi la disattivazione? (s/N): ");
                    String conferma = scanner.nextLine().trim().toLowerCase();
                    if (conferma.equals("s") || conferma.equals("si")) {
                        attivi[indice] = false;
                        System.out.println("‚úÖ Prodotto disattivato.");
                    } else {
                        System.out.println("‚ùå Disattivazione annullata.");
                        return;
                    }
                }
                break;
                
            case 7: // Riattiva prodotto
                if (attivi[indice]) {
                    System.out.println("‚ö†Ô∏è Il prodotto √® gi√† attivo.");
                } else {
                    attivi[indice] = true;
                    System.out.println("‚úÖ Prodotto riattivato.");
                }
                break;
                
            case 0: // Annulla
                System.out.println("‚ùå Modifica annullata.");
                return;
                
            default:
                System.out.println("‚ùå Scelta non valida!");
                return;
        }
        
        System.out.println("\n‚úÖ Prodotto modificato con successo!");
        System.out.println("üì¶ PRODOTTO AGGIORNATO:");
        stampaProdotto(indice);
    }
    
    /**
     * SOLUZIONE 4: Calcolo valore magazzino con dettagli finanziari completi
     */
    private static void calcolaValore() {
        System.out.println("\n=== üí∞ CALCOLO VALORE MAGAZZINO ===");
        
        if (numProdotti == 0) {
            System.out.println("üì≠ Nessun prodotto nel magazzino.");
            return;
        }
        
        int prodottiAttivi = contaProdottiAttivi();
        if (prodottiAttivi == 0) {
            System.out.println("üì≠ Tutti i prodotti sono disattivati.");
            return;
        }
        
        // Variabili per calcoli finanziari
        BigDecimal valoreLordo = BigDecimal.ZERO;
        BigDecimal valoreConSconti = BigDecimal.ZERO;
        BigDecimal totaleSconti = BigDecimal.ZERO;
        
        System.out.println("\nüìä DETTAGLIO CALCOLI PER PRODOTTO:");
        System.out.println("‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê");
        System.out.println("‚îÇ  CODICE  ‚îÇ VAL. LORDO  ‚îÇ   SCONTO    ‚îÇ VAL. SCONTO ‚îÇ VAL. FINALE ‚îÇ");
        System.out.println("‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§");
        
        // Calcolo per ogni prodotto attivo
        for (int i = 0; i < numProdotti; i++) {
            if (attivi[i]) {
                // Uso BigDecimal per precisione nei calcoli monetari
                BigDecimal prezzo = BigDecimal.valueOf(prezziUnitari[i]);
                BigDecimal qta = BigDecimal.valueOf(quantita[i]);
                BigDecimal percentualeSconto = BigDecimal.valueOf(sconti[i] / 100);
                
                BigDecimal valLordo = prezzo.multiply(qta);
                BigDecimal valSconto = valLordo.multiply(percentualeSconto);
                BigDecimal valFinale = valLordo.subtract(valSconto);
                
                // Accumula totali
                valoreLordo = valoreLordo.add(valLordo);
                totaleSconti = totaleSconti.add(valSconto);
                valoreConSconti = valoreConSconti.add(valFinale);
                
                // Stampa riga
                System.out.printf("‚îÇ %-8s ‚îÇ %11s ‚îÇ %11s ‚îÇ %11s ‚îÇ %11s ‚îÇ%n",
                    codici[i],
                    formattoPrezzo.format(valLordo.doubleValue()),
                    formattoPrezzo.format(valSconto.doubleValue()),
                    formattoPrezzo.format(valFinale.doubleValue()),
                    formattoPrezzo.format(valFinale.doubleValue())
                );
            }
        }
        
        System.out.println("‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò");
        
        // Calcoli finali con IVA
        BigDecimal ivaPercentuale = BigDecimal.valueOf(IVA_STANDARD);
        BigDecimal iva = valoreConSconti.multiply(ivaPercentuale);
        BigDecimal valoreTotaleConIVA = valoreConSconti.add(iva);
        
        // Report finanziario dettagliato
        System.out.println("\nüí∞ RIEPILOGO FINANZIARIO DETTAGLIATO:");
        System.out.println("‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê");
        System.out.println("‚îÇ DESCRIZIONE                     ‚îÇ      IMPORTO    ‚îÇ");
        System.out.println("‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§");
        System.out.printf("‚îÇ üí∏ Valore lordo magazzino       ‚îÇ %15s ‚îÇ%n", 
                         formattoPrezzo.format(valoreLordo.doubleValue()));
        System.out.printf("‚îÇ üè∑Ô∏è Totale sconti applicati      ‚îÇ %15s ‚îÇ%n", 
                         formattoPrezzo.format(totaleSconti.doubleValue()));
        System.out.printf("‚îÇ üíµ Valore netto (con sconti)    ‚îÇ %15s ‚îÇ%n", 
                         formattoPrezzo.format(valoreConSconti.doubleValue()));
        System.out.printf("‚îÇ üèõÔ∏è IVA (%s)                    ‚îÇ %15s ‚îÇ%n", 
                         formattoPercentuale.format(IVA_STANDARD),
                         formattoPrezzo.format(iva.doubleValue()));
        System.out.println("‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§");
        System.out.printf("‚îÇ üíé VALORE TOTALE CON IVA        ‚îÇ %15s ‚îÇ%n", 
                         formattoPrezzo.format(valoreTotaleConIVA.doubleValue()));
        System.out.println("‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò");
        
        // Analisi percentuali
        if (valoreLordo.compareTo(BigDecimal.ZERO) > 0) {
            double percentualeSconti = totaleSconti.divide(valoreLordo, 4, RoundingMode.HALF_UP).doubleValue();
            System.out.printf("\nüìà ANALISI PERCENTUALI:%n");
            System.out.printf("üè∑Ô∏è Incidenza sconti sul totale: %s%n", 
                             formattoPercentuale.format(percentualeSconti));
            System.out.printf("üèõÔ∏è Incidenza IVA sul netto: %s%n", 
                             formattoPercentuale.format(IVA_STANDARD));
        }
        
        // Statistiche aggiuntive
        System.out.printf("\nüìä STATISTICHE AGGIUNTIVE:%n");
        System.out.printf("üì¶ Prodotti inclusi nel calcolo: %d%n", prodottiAttivi);
        System.out.printf("üí∞ Valore medio per prodotto: %s%n", 
                         formattoPrezzo.format(valoreConSconti.divide(BigDecimal.valueOf(prodottiAttivi), 2, RoundingMode.HALF_UP).doubleValue()));
    }
    
    /**
     * SOLUZIONE 5: Gestione inventario completa
     */
    private static void gestioneInventario() {
        System.out.println("\n=== üìä GESTIONE INVENTARIO ===");
        
        System.out.println("1. üîç Visualizza scorte basse");
        System.out.println("2. üì¶ Carico merce");
        System.out.println("3. üì§ Scarico merce");
        System.out.println("4. üìã Report inventario completo");
        System.out.println("0. üîô Torna al menu principale");
        
        int scelta = leggiIntero("üëâ Scelta: ");
        
        switch (scelta) {
            case 1:
                visualizzaScorteBasse();
                break;
            case 2:
                caricoMerce();
                break;
            case 3:
                scaricoMerce();
                break;
            case 4:
                reportInventario();
                break;
            case 0:
                return;
            default:
                System.out.println("‚ùå Scelta non valida!");
        }
    }
    
    /**
     * SOLUZIONE 6: Generazione report completo professionale
     */
    private static void generaReport() {
        System.out.println("\n=== üìÑ GENERAZIONE REPORT COMPLETO ===");
        
        LocalDateTime ora = LocalDateTime.now();
        
        System.out.println("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
        System.out.println("‚ïë                           REPORT MAGAZZINO                            ‚ïë");
        System.out.println("‚ïë                         SISTEMA GESTIONALE                            ‚ïë");
        System.out.println("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£");
        System.out.printf("‚ïë üìÖ Data generazione: %-47s ‚ïë%n", ora.format(formattoData));
        System.out.printf("‚ïë üè¢ Sistema: Gestione Magazzino v1.0 %-33s ‚ïë%n", "");
        System.out.println("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
        
        // Sezione 1: Riepilogo generale
        System.out.println("\nüìä 1. RIEPILOGO GENERALE");
        System.out.println("‚îÄ".repeat(50));
        System.out.printf("üì¶ Prodotti totali inseriti: %d%n", numProdotti);
        System.out.printf("‚úÖ Prodotti attivi: %d%n", contaProdottiAttivi());
        System.out.printf("‚ùå Prodotti disattivati: %d%n", numProdotti - contaProdottiAttivi());
        System.out.printf("‚ö†Ô∏è Prodotti con scorte basse: %d%n", contaScorteBasse());
        System.out.printf("üí∞ Valore totale magazzino: %s%n", formattoPrezzo.format(calcolaValoreTotale()));
        
        // Sezione 2: Analisi per categoria
        System.out.println("\nüìÇ 2. ANALISI PER CATEGORIA");
        System.out.println("‚îÄ".repeat(50));
        analisiPerCategoria();
        
        // Sezione 3: Prodotti con scorte critiche
        System.out.println("\n‚ö†Ô∏è 3. SCORTE CRITICHE");
        System.out.println("‚îÄ".repeat(50));
        reportScorteCritiche();
        
        // Sezione 4: Top prodotti per valore
        System.out.println("\nüèÜ 4. TOP PRODOTTI PER VALORE");
        System.out.println("‚îÄ".repeat(50));
        topProdottiPerValore();
        
        // Sezione 5: Calcoli finanziari dettagliati
        System.out.println("\nüí∞ 5. ANALISI FINANZIARIA");
        System.out.println("‚îÄ".repeat(50));
        analisiFinanziaria();
        
        System.out.println("\n" + "‚ïê".repeat(70));
        System.out.println("üìÑ FINE REPORT - Generato automaticamente dal sistema");
        System.out.println("‚ïê".repeat(70));
    }
    
    /**
     * SOLUZIONE 7: Ricerca prodotti con criteri multipli
     */
    private static void ricercaProdotti() {
        System.out.println("\n=== üîç RICERCA PRODOTTI ===");
        
        if (numProdotti == 0) {
            System.out.println("üì≠ Nessun prodotto da cercare.");
            return;
        }
        
        System.out.println("üîé CRITERI DI RICERCA DISPONIBILI:");
        System.out.println("1. üî§ Ricerca per codice esatto");
        System.out.println("2. üìù Ricerca per nome (parziale)");
        System.out.println("3. üìÇ Ricerca per categoria");
        System.out.println("4. üí∞ Ricerca per range di prezzo");
        System.out.println("5. üì¶ Ricerca per quantit√†");
        System.out.println("0. üîô Torna al menu principale");
        
        int criterio = leggiIntero("üëâ Criterio di ricerca: ");
        
        switch (criterio) {
            case 1: // Ricerca per codice
                ricercaPerCodice();
                break;
            case 2: // Ricerca per nome
                ricercaPerNome();
                break;
            case 3: // Ricerca per categoria
                ricercaPerCategoria();
                break;
            case 4: // Ricerca per range prezzo
                ricercaPerRangePrezzo();
                break;
            case 5: // Ricerca per quantit√†
                ricercaPerQuantita();
                break;
            case 0:
                return;
            default:
                System.out.println("‚ùå Criterio non valido!");
        }
    }
    
    // ==================== METODI DI UTILIT√Ä E SUPPORTO ====================
    
    /**
     * Valida il formato del codice prodotto (PRD-XXXX)
     */
    private static boolean validaCodice(String codice) {
        if (codice == null || codice.length() != 8) {
            return false;
        }
        
        if (!codice.startsWith("PRD-")) {
            return false;
        }
        
        String numero = codice.substring(4);
        try {
            Integer.parseInt(numero);
            return true;
        } catch (NumberFormatException e) {
            return false;
        }
    }
    
    /**
     * Verifica se un codice esiste gi√†
     */
    private static boolean esisteCodice(String codice) {
        for (int i = 0; i < numProdotti; i++) {
            if (codici[i].equals(codice)) {
                return true;
            }
        }
        return false;
    }
    
    /**
     * Metodo per scegliere una categoria da una lista predefinita
     */
    private static String scegliCategoria() {
        String[] categorie = {"ELETTRONICA", "ABBIGLIAMENTO", "CASA", "SPORT", "LIBRI", "ALIMENTARI", "ALTRO"};
        
        System.out.println("üìÇ CATEGORIE DISPONIBILI:");
        for (int i = 0; i < categorie.length; i++) {
            System.out.printf("%d. %s%n", i + 1, categorie[i]);
        }
        
        int scelta;
        do {
            scelta = leggiIntero("üëâ Categoria (1-" + categorie.length + "): ");
            if (scelta < 1 || scelta > categorie.length) {
                System.out.println("‚ùå Scelta non valida!");
            }
        } while (scelta < 1 || scelta > categorie.length);
        
        return categorie[scelta - 1];
    }
    
    /**
     * Trova un prodotto per codice
     */
    private static int trovaProdotto(String codice) {
        for (int i = 0; i < numProdotti; i++) {
            if (attivi[i] && codici[i].equals(codice)) {
                return i;
            }
        }
        return -1;
    }
    
    /**
     * Calcola il valore totale di un prodotto (prezzo √ó quantit√† - sconto)
     */
    private static double calcolaValoreProdotto(int indice) {
        double valoreLordo = prezziUnitari[indice] * quantita[indice];
        double sconto = valoreLordo * (sconti[indice] / 100);
        return valoreLordo - sconto;
    }
    
    /**
     * Calcola il valore totale del magazzino
     */
    private static double calcolaValoreTotale() {
        double totale = 0;
        for (int i = 0; i < numProdotti; i++) {
            if (attivi[i]) {
                totale += calcolaValoreProdotto(i);
            }
        }
        return totale;
    }
    
    /**
     * Conta i prodotti attivi
     */
    private static int contaProdottiAttivi() {
        int count = 0;
        for (int i = 0; i < numProdotti; i++) {
            if (attivi[i]) count++;
        }
        return count;
    }
    
    /**
     * Conta prodotti con scorte basse
     */
    private static int contaScorteBasse() {
        int count = 0;
        for (int i = 0; i < numProdotti; i++) {
            if (attivi[i] && quantita[i] <= SOGLIA_SCORTE_BASSE) {
                count++;
            }
        }
        return count;
    }
    
    /**
     * Limita la lunghezza di una stringa per la formattazione tabellare
     */
    private static String limitaStringa(String str, int maxLength) {
        if (str.length() <= maxLength) {
            return str;
        }
        return str.substring(0, maxLength - 3) + "...";
    }
    
    /**
     * Stampa i dettagli di un singolo prodotto
     */
    private static void stampaProdotto(int indice) {
        String status = attivi[indice] ? "‚úÖ ATTIVO" : "‚ùå DISATTIVATO";
        String alertScorte = quantita[indice] <= SOGLIA_SCORTE_BASSE ? " ‚ö†Ô∏è SCORTE BASSE" : "";
        
        System.out.printf("üè∑Ô∏è %s - %s (%s) %s%s%n", 
                         codici[indice], nomi[indice], categorie[indice], status, alertScorte);
        System.out.printf("   üí∞ Prezzo: %s | üì¶ Quantit√†: %d | üè∑Ô∏è Sconto: %s%n",
                         formattoPrezzo.format(prezziUnitari[indice]),
                         quantita[indice],
                         formattoPercentuale.format(sconti[indice] / 100));
        System.out.printf("   üíé Valore totale: %s%n", formattoPrezzo.format(calcolaValoreProdotto(indice)));
    }
    
    /**
     * Implementazione metodi per gestione inventario
     */
    private static void visualizzaScorteBasse() {
        System.out.println("\n‚ö†Ô∏è PRODOTTI CON SCORTE BASSE");
        System.out.printf("(Soglia critica: %.0f unit√†)%n%n", SOGLIA_SCORTE_BASSE);
        
        boolean trovati = false;
        for (int i = 0; i < numProdotti; i++) {
            if (attivi[i] && quantita[i] <= SOGLIA_SCORTE_BASSE) {
                if (!trovati) {
                    System.out.println("‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê");
                    System.out.println("‚îÇ  CODICE  ‚îÇ        NOME        ‚îÇ  CATEGORIA  ‚îÇ   QT√Ä   ‚îÇ");
                    System.out.println("‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§");
                    trovati = true;
                }
                
                System.out.printf("‚îÇ %-8s ‚îÇ %-18s ‚îÇ %-11s ‚îÇ %7d ‚îÇ%n",
                    codici[i],
                    limitaStringa(nomi[i], 18),
                    limitaStringa(categorie[i], 11),
                    quantita[i]
                );
            }
        }
        
        if (trovati) {
            System.out.println("‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò");
            System.out.println("üí° Suggerimento: Usa 'Carico merce' per rifornire questi prodotti.");
        } else {
            System.out.println("‚úÖ Tutti i prodotti hanno scorte sufficienti!");
        }
    }
    
    private static void caricoMerce() {
        System.out.println("\nüì¶ CARICO MERCE");
        
        System.out.print("üîç Codice prodotto da rifornire: ");
        String codice = scanner.nextLine().trim().toUpperCase();
        
        int indice = trovaProdotto(codice);
        if (indice == -1) {
            System.out.println("‚ùå Prodotto non trovato!");
            return;
        }
        
        System.out.printf("üì¶ Quantit√† attuale: %d%n", quantita[indice]);
        int qtaCarico = leggiIntero("üì¶ Quantit√† da caricare: ");
        
        if (qtaCarico <= 0) {
            System.out.println("‚ùå La quantit√† deve essere positiva!");
            return;
        }
        
        int vecchiaQta = quantita[indice];
        quantita[indice] += qtaCarico;
        
        System.out.println("‚úÖ Carico completato!");
        System.out.printf("üìä %s: %d ‚Üí %d (+%d)%n", nomi[indice], vecchiaQta, quantita[indice], qtaCarico);
        
        if (vecchiaQta <= SOGLIA_SCORTE_BASSE && quantita[indice] > SOGLIA_SCORTE_BASSE) {
            System.out.println("üéâ Prodotto non √® pi√π in scorte basse!");
        }
    }
    
    private static void scaricoMerce() {
        System.out.println("\nüì§ SCARICO MERCE");
        
        System.out.print("üîç Codice prodotto da scaricare: ");
        String codice = scanner.nextLine().trim().toUpperCase();
        
        int indice = trovaProdotto(codice);
        if (indice == -1) {
            System.out.println("‚ùå Prodotto non trovato!");
            return;
        }
        
        System.out.printf("üì¶ Quantit√† disponibile: %d%n", quantita[indice]);
        int qtaScarico = leggiIntero("üì§ Quantit√† da scaricare: ");
        
        if (qtaScarico <= 0) {
            System.out.println("‚ùå La quantit√† deve essere positiva!");
            return;
        }
        
        if (qtaScarico > quantita[indice]) {
            System.out.printf("‚ùå Quantit√† insufficiente! Disponibili: %d%n", quantita[indice]);
            return;
        }
        
        int vecchiaQta = quantita[indice];
        quantita[indice] -= qtaScarico;
        
        System.out.println("‚úÖ Scarico completato!");
        System.out.printf("üìä %s: %d ‚Üí %d (-%d)%n", nomi[indice], vecchiaQta, quantita[indice], qtaScarico);
        
        if (quantita[indice] <= SOGLIA_SCORTE_BASSE) {
            System.out.println("‚ö†Ô∏è ATTENZIONE: Il prodotto √® ora in scorte basse!");
        }
    }
    
    private static void reportInventario() {
        System.out.println("\nüìã REPORT INVENTARIO COMPLETO");
        System.out.println("‚ïê".repeat(60));
        
        // Statistiche generali
        int totaleUnita = 0;
        double valoreTotale = 0;
        
        for (int i = 0; i < numProdotti; i++) {
            if (attivi[i]) {
                totaleUnita += quantita[i];
                valoreTotale += calcolaValoreProdotto(i);
            }
        }
        
        System.out.printf("üìä Unit√† totali in magazzino: %d%n", totaleUnita);
        System.out.printf("üí∞ Valore totale inventario: %s%n", formattoPrezzo.format(valoreTotale));
        System.out.printf("üì¶ Prodotti diversi: %d%n", contaProdottiAttivi());
        System.out.printf("‚ö†Ô∏è Prodotti sotto soglia: %d%n", contaScorteBasse());
        
        System.out.println("\nüìà DISTRIBUZIONE SCORTE:");
        System.out.println("‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê");
        System.out.println("‚îÇ   CATEGORIA     ‚îÇ   UNIT√Ä TOTALI ‚îÇ");
        System.out.println("‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§");
        
        // Analisi per categoria
        String[] categorieLista = {"ELETTRONICA", "ABBIGLIAMENTO", "CASA", "SPORT", "LIBRI", "ALIMENTARI", "ALTRO"};
        for (String cat : categorieLista) {
            int unitaCategoria = 0;
            for (int i = 0; i < numProdotti; i++) {
                if (attivi[i] && categorie[i].equals(cat)) {
                    unitaCategoria += quantita[i];
                }
            }
            if (unitaCategoria > 0) {
                System.out.printf("‚îÇ %-15s ‚îÇ %14d ‚îÇ%n", cat, unitaCategoria);
            }
        }
        System.out.println("‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò");
    }
    
    /**
     * Implementazione metodi per ricerca
     */
    private static void ricercaPerCodice() {
        System.out.print("üî§ Inserisci codice da cercare: ");
        String codice = scanner.nextLine().trim().toUpperCase();
        
        int indice = trovaProdotto(codice);
        if (indice == -1) {
            System.out.println("‚ùå Nessun prodotto trovato con questo codice.");
        } else {
            System.out.println("\n‚úÖ PRODOTTO TROVATO:");
            stampaProdotto(indice);
        }
    }
    
    private static void ricercaPerNome() {
        System.out.print("üìù Inserisci parte del nome: ");
        String ricerca = scanner.nextLine().trim().toLowerCase();
        
        if (ricerca.isEmpty()) {
            System.out.println("‚ùå Testo di ricerca vuoto!");
            return;
        }
        
        System.out.println("\nüîç RISULTATI RICERCA:");
        boolean trovato = false;
        
        for (int i = 0; i < numProdotti; i++) {
            if (attivi[i] && nomi[i].toLowerCase().contains(ricerca)) {
                if (!trovato) {
                    System.out.println("‚îÄ".repeat(40));
                    trovato = true;
                }
                stampaProdotto(i);
                System.out.println();
            }
        }
        
        if (!trovato) {
            System.out.println("‚ùå Nessun prodotto trovato con questo nome.");
        }
    }
    
    private static void ricercaPerCategoria() {
        String categoria = scegliCategoria();
        
        System.out.printf("\nüîç PRODOTTI CATEGORIA: %s%n", categoria);
        System.out.println("‚îÄ".repeat(40));
        
        boolean trovato = false;
        for (int i = 0; i < numProdotti; i++) {
            if (attivi[i] && categorie[i].equals(categoria)) {
                stampaProdotto(i);
                System.out.println();
                trovato = true;
            }
        }
        
        if (!trovato) {
            System.out.printf("‚ùå Nessun prodotto trovato nella categoria %s.%n", categoria);
        }
    }
    
    private static void ricercaPerRangePrezzo() {
        double prezzoMin = leggiDouble("üí∞ Prezzo minimo (‚Ç¨): ");
        double prezzoMax = leggiDouble("üí∞ Prezzo massimo (‚Ç¨): ");
        
        if (prezzoMin > prezzoMax) {
            System.out.println("‚ùå Il prezzo minimo non pu√≤ essere maggiore del massimo!");
            return;
        }
        
        System.out.printf("\nüîç PRODOTTI NEL RANGE ‚Ç¨%.2f - ‚Ç¨%.2f:%n", prezzoMin, prezzoMax);
        System.out.println("‚îÄ".repeat(40));
        
        boolean trovato = false;
        for (int i = 0; i < numProdotti; i++) {
            if (attivi[i] && prezziUnitari[i] >= prezzoMin && prezziUnitari[i] <= prezzoMax) {
                stampaProdotto(i);
                System.out.println();
                trovato = true;
            }
        }
        
        if (!trovato) {
            System.out.println("‚ùå Nessun prodotto trovato in questo range di prezzo.");
        }
    }
    
    private static void ricercaPerQuantita() {
        int qtaMin = leggiIntero("üì¶ Quantit√† minima: ");
        int qtaMax = leggiIntero("üì¶ Quantit√† massima: ");
        
        if (qtaMin > qtaMax) {
            System.out.println("‚ùå La quantit√† minima non pu√≤ essere maggiore della massima!");
            return;
        }
        
        System.out.printf("\nüîç PRODOTTI CON QUANTIT√Ä %d - %d:%n", qtaMin, qtaMax);
        System.out.println("‚îÄ".repeat(40));
        
        boolean trovato = false;
        for (int i = 0; i < numProdotti; i++) {
            if (attivi[i] && quantita[i] >= qtaMin && quantita[i] <= qtaMax) {
                stampaProdotto(i);
                System.out.println();
                trovato = true;
            }
        }
        
        if (!trovato) {
            System.out.println("‚ùå Nessun prodotto trovato in questo range di quantit√†.");
        }
    }
    
    /**
     * Metodi per analisi avanzate nel report
     */
    private static void analisiPerCategoria() {
        String[] categorieLista = {"ELETTRONICA", "ABBIGLIAMENTO", "CASA", "SPORT", "LIBRI", "ALIMENTARI", "ALTRO"};
        
        System.out.println("‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê");
        System.out.println("‚îÇ   CATEGORIA     ‚îÇ PRODOTTI ‚îÇ VALORE TOTALE   ‚îÇ");
        System.out.println("‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§");
        
        for (String cat : categorieLista) {
            int conteggio = 0;
            double valore = 0;
            
            for (int i = 0; i < numProdotti; i++) {
                if (attivi[i] && categorie[i].equals(cat)) {
                    conteggio++;
                    valore += calcolaValoreProdotto(i);
                }
            }
            
            if (conteggio > 0) {
                System.out.printf("‚îÇ %-15s ‚îÇ %8d ‚îÇ %15s ‚îÇ%n", 
                                cat, conteggio, formattoPrezzo.format(valore));
            }
        }
        System.out.println("‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò");
    }
    
    private static void reportScorteCritiche() {
        boolean haScorteCritiche = false;
        
        for (int i = 0; i < numProdotti; i++) {
            if (attivi[i] && quantita[i] <= SOGLIA_SCORTE_BASSE) {
                if (!haScorteCritiche) {
                    System.out.printf("‚ö†Ô∏è Soglia critica: %.0f unit√†%n%n", SOGLIA_SCORTE_BASSE);
                    haScorteCritiche = true;
                }
                System.out.printf("üî¥ %s (%s) - Quantit√†: %d%n", 
                                nomi[i], codici[i], quantita[i]);
            }
        }
        
        if (!haScorteCritiche) {
            System.out.println("‚úÖ Nessun prodotto in scorte critiche.");
        }
    }
    
    private static void topProdottiPerValore() {
        if (numProdotti == 0) return;
        
        // Creiamo array di indici ordinati per valore
        int[] indiciOrdinati = new int[numProdotti];
        int count = 0;
        
        for (int i = 0; i < numProdotti; i++) {
            if (attivi[i]) {
                indiciOrdinati[count++] = i;
            }
        }
        
        // Ordinamento bubble sort per valore decrescente
        for (int i = 0; i < count - 1; i++) {
            for (int j = 0; j < count - i - 1; j++) {
                if (calcolaValoreProdotto(indiciOrdinati[j]) < calcolaValoreProdotto(indiciOrdinati[j + 1])) {
                    int temp = indiciOrdinati[j];
                    indiciOrdinati[j] = indiciOrdinati[j + 1];
                    indiciOrdinati[j + 1] = temp;
                }
            }
        }
        
        // Mostra top 5
        int limite = Math.min(5, count);
        for (int i = 0; i < limite; i++) {
            int idx = indiciOrdinati[i];
            System.out.printf("üèÜ #%d: %s - %s%n", 
                            i + 1, nomi[idx], formattoPrezzo.format(calcolaValoreProdotto(idx)));
        }
    }
    
    private static void analisiFinanziaria() {
        double valoreTotale = calcolaValoreTotale();
        double iva = valoreTotale * IVA_STANDARD;
        
        System.out.printf("üíµ Valore netto magazzino: %s%n", formattoPrezzo.format(valoreTotale));
        System.out.printf("üèõÔ∏è IVA da versare: %s%n", formattoPrezzo.format(iva));
        System.out.printf("üíé Valore lordo con IVA: %s%n", formattoPrezzo.format(valoreTotale + iva));
        
        if (contaProdottiAttivi() > 0) {
            double valoremedio = valoreTotale / contaProdottiAttivi();
            System.out.printf("üìä Valore medio per prodotto: %s%n", formattoPrezzo.format(valoremedio));
        }
    }
    
    /**
     * Metodi di utilit√† per input validato
     */
    private static int leggiIntero(String messaggio) {
        System.out.print(messaggio);
        while (!scanner.hasNextInt()) {
            System.out.print("‚ùå Inserisci un numero intero valido: ");
            scanner.next();
        }
        int numero = scanner.nextInt();
        scanner.nextLine(); // Consuma il newline
        return numero;
    }
    
    private static double leggiDouble(String messaggio) {
        System.out.print(messaggio);
        while (!scanner.hasNextDouble()) {
            System.out.print("‚ùå Inserisci un numero valido: ");
            scanner.next();
        }
        double numero = scanner.nextDouble();
        scanner.nextLine(); // Consuma il newline
        return numero;
    }
    
    /**
     * Carica dati di esempio per il testing e dimostrazione
     */
    private static void caricaDatiEsempio() {
        // Prodotto 1 - Elettronica
        codici[0] = "PRD-0001";
        nomi[0] = "Smartphone XYZ Pro";
        categorie[0] = "ELETTRONICA";
        prezziUnitari[0] = 299.99;
        quantita[0] = 15;
        sconti[0] = 10.0;
        attivi[0] = true;
        
        // Prodotto 2 - Abbigliamento (scorte basse)
        codici[1] = "PRD-0002";
        nomi[1] = "T-Shirt Cotone Bio";
        categorie[1] = "ABBIGLIAMENTO";
        prezziUnitari[1] = 19.90;
        quantita[1] = 5; // Scorte basse
        sconti[1] = 0.0;
        attivi[1] = true;
        
        // Prodotto 3 - Casa
        codici[2] = "PRD-0003";
        nomi[2] = "Lampada LED Smart";
        categorie[2] = "CASA";
        prezziUnitari[2] = 45.50;
        quantita[2] = 25;
        sconti[2] = 15.0;
        attivi[2] = true;
        
        // Prodotto 4 - Sport (scorte critiche)
        codici[3] = "PRD-0004";
        nomi[3] = "Scarpe Running Pro";
        categorie[3] = "SPORT";
        prezziUnitari[3] = 89.99;
        quantita[3] = 3; // Scorte critiche
        sconti[3] = 5.0;
        attivi[3] = true;
        
        numProdotti = 4;
        
        System.out.printf("‚úÖ Sistema inizializzato con %d prodotti di esempio%n", numProdotti);
        System.out.printf("üí∞ Valore iniziale magazzino: %s%n", formattoPrezzo.format(calcolaValoreTotale()));
        System.out.printf("‚ö†Ô∏è Prodotti con scorte basse: %d%n", contaScorteBasse());
        System.out.println("üìö Pronto per l'utilizzo!");
    }
}
